<shaders>
  <!-- Creates a spotlight effect centered on the player with configurable radius and ambient lighting -->
  <shader name="PlayerSpotlight" description="Creates a spotlight effect centered on the player with configurable radius and ambient lighting">
    <parameters>
      <param name="PlayerPos" type="vec2" studioType="playerpos"/>
      <param name="Radius" type="float" default="0.05" min="0.01" max="0.5" step="0.01"/>
      <param name="Softness" type="float" default="0.16" min="0.0" max="0.5" step="0.02"/>
      <param name="Ambient" type="float" default="0.2" min="0.0" max="1.0" step="0.05"/>
    </parameters>
    <vertex><![CDATA[
attribute vec3 Position;
attribute vec4 Color;
attribute vec2 TexCoord;
attribute vec4 RenderData;
attribute float Scale;

attribute vec2 PlayerPos;
attribute float Radius;
attribute float Softness;
attribute float Ambient;

uniform mat4 Transform;

varying vec4 Color0;
varying vec2 TexCoord0;
varying vec4 RenderDataOut;
varying float ScaleOut;

varying vec2 PlayerPosOut;
varying float RadiusOut;
varying float SoftnessOut;
varying float AmbientOut;

void main(void) {
    Color0 = Color;
    TexCoord0 = TexCoord;
    RenderDataOut = RenderData;
    ScaleOut = Scale;
    PlayerPosOut = PlayerPos;
    RadiusOut = Radius;
    SoftnessOut = Softness;
    AmbientOut = Ambient;
    gl_Position = Transform * vec4(Position.xyz, 1.0);
}
    ]]></vertex>
    <fragment><![CDATA[
varying lowp vec4 Color0;
varying mediump vec2 TexCoord0;
varying lowp vec4 RenderDataOut;
varying lowp float ScaleOut;

varying mediump vec2 PlayerPosOut;
varying lowp float RadiusOut;
varying lowp float SoftnessOut;
varying lowp float AmbientOut;

uniform sampler2D Texture0;

void main(void) {
    vec4 tex = texture2D(Texture0, TexCoord0);

    // Convert screen pixel position to normalized 0-1 space
    // PlayerPosOut is in screen pixels from WorldToScreen()
    // RenderDataOut.zw contains texture dimensions
    // ScaleOut is the room zoom level (typically 0.5)
    vec2 center = (PlayerPosOut / RenderDataOut.zw) * ScaleOut;

    // Compute aspect ratio to make spotlight circular, not oval
    float aspectRatio = RenderDataOut.z / RenderDataOut.w;

    // Scale X coordinate by aspect ratio for proper circular distance
    vec2 diff = TexCoord0 - center;
    diff.x *= aspectRatio;
    float dist = length(diff);

    // Scale radius by aspect ratio as well for consistent sizing
    float adjustedRadius = RadiusOut * aspectRatio;
    float adjustedSoftness = SoftnessOut * aspectRatio;

    float spotlight = smoothstep(adjustedRadius + adjustedSoftness, adjustedRadius, dist);

    // Ambient controls minimum brightness outside spotlight
    // Higher values = more visible surroundings, lower = darker horror effect
    gl_FragColor = Color0 * tex * (AmbientOut + (1.0 - AmbientOut) * spotlight);
}
    ]]></fragment>
  </shader>
</shaders>
